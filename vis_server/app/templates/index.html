<html>

<head>
    <style media="screen" type="text/css">
        body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: #000;
            color: #F00;
        }
        #gl_canvas {
            border: thin solid #0F0;
            margin: auto auto;
            display: block;
        }
        .floatLeft {
            float: Left;
        }
        .floatRight {
            float: Right;
        }
        .warningBox {
            text-align:center;
            color: #0F0;
            padding: 15px;
            width: 100px;
            height: 50px;
            margin-top: 20px;
        }
        .warningBox span {
            text-height: 20px;
        }
        .largeLabel {
            text-align:center;
            color: #0F0;
            padding: 15px;
            width: 100px;
            height: 50px;
            margin-top: 20px;
        }
        .largeLabel span {
            text-height:20px;
            font-size: 40px;
        }
        .smallLabel {
            margin: -20px 0px 20px 20px;
        }
        .smallLabel span {
            text-height:10px;
            font-size: 18px;
            color: #0F0;
        }
        .button {
            text-align:center;
            color: #0F0;
            padding: 15px;
            width: 100px;
            height: 20px;
            border: thin solid #0F0;

            -webkit-user-select: none; /* Chrome/Safari */        
            -moz-user-select: none; /* Firefox */
            -ms-user-select: none; /* IE10+ */
        }
        .button span {
            text-height:20px;
        }
        .button:hover {
            background-color: #555;
            cursor: pointer;
        }
        .button.selected {
            background-color: #555;
        }
        .button.smallButton {
            width: 20px;
            padding: 4px;
        }
        .button.halfButton {
            width: 35px;
        }
        .slim {
            height: 20px !important;
            padding: 2px !important;
            width: 61px !important;
        }
        .slim span {
            height 5px; !important
        }
        .indicator {
            height: 20px;
            width: 20px;
            background-color: #007500;
            border-radius: 50%;
            display: none;
        }
        .controls {
            display: block;
            position: absolute;
        }
        .loadBox {
            position: absolute;
            display: block;
            z-index: 100;
            background-color: #000;
            color: #0F0;
            width: 450px;
            border: thin solid #0F0;
            padding: 10px 40px;
        }
        .frame_slider {
            margin: 0px;
        }
        .hidden {
            display: None;
        }
        .loadBox p {
            margin: 5px;
            padding: 0px;
            float: left;
            width:100%
        }
        .loadBox input {
            line-height:2;
            width: 300px;
        }
        .loadBox select{
            line-height:2;
            min-width: 300px;
            margin: 5px 0px;
        }
        .loadBox table {
            color: #0F0;
        }
        .loadBox td {
            padding: 5px 15px;
        }
        .loadBox table input{
            width: 75px;
        }
        input.norming_value_input{
            width: 75px;
            line-height: 1;
            margin-left: 10px;
        }
        .width100 {
            width: 100%;
        }
        
        .slider {
            background-image: -webkit-gradient(linear,left top,right top,color-stop(0, blue),color-stop(' + value + ', red)
        }
    </style>

    <title>my awesome website</title>

</head>

<body>
    
    <div class="controls">
        <div class="button selected" id="load_button"><span>load</span></div>
        <div class="loadBox" id="load_box">
            <p>file selection:</p>
            <p style="width:auto;margin:0px 5px">
                <input type="text" id="file_input" class="textInput floatLeft">
                <div class="button smallButton floatLeft" id="file_get"><span>go</span></div>
                <div class="button smallButton floatRight" id="file_cancel"><span>X</span></div>
            </p>
            <div class="width100"></div>
            <p style="width:auto;margin:0px 5px">
                <select id="file_select"></select>
                <div class="button smallButton floatLeft" id="file_up_level"><span>..</span></div>
            </p>
            <div>
                <p><span class="floatLeft" >normalizing constants:</span>
                    <input type="text" class="norming_value_input floatLeft" id="ch1_norm_input">
                    <input type="text" class="norming_value_input floatLeft" id="ch2_norm_input">
                </p>
            </div>
            <p style="width:auto;margin:0px 5px">
                <select class="floatLeft" id="channel_select"></select>
                <div class="button smallButton floatLeft" id="load_dataset_button"><span>ok</span></div>
            </p>

         </div>
         <div class="button" id="options_button"><span>options</span></div>
         <div class="loadBox hidden" id="options_box">
            <p style="width:auto;margin:0px 5px">
                <table class="floatLeft">
                    <tr>
                        <td>frame rate:</td>
                        <td><input type="text" id="frame_rate_input" class="textInput floatLeft"></td>
                        <td>Hz</td>
                    </tr>
                    <tr>
                        <td>packet size:</td>
                        <td><input type="text" id="packet_size_input" class="textInput floatLeft"></td>
                        <td>frames</td>
                    </tr>
                    <tr>
                        <td>buffer size:</td>
                        <td><input type="text" id="buffer_size_input" class="textInput floatLeft"></td>
                        <td>frames</td>
                    </tr>
                </table>
                <div class="button smallButton floatRight" id="options_cancel"><span>ok</span></div>
            </p>
        </div>
        <div class="button" id="start_button"><span>start</span></div>
        <div class="button" id="stop_button"><span>stop</span></div>
        <div class="largeLabel" id="frame_number_label">
            <span>
                <span id="this_frame_label">0</span>/<span id="frame_num_label">0</span>
            </span>
        </div>
        <div class="smallLabel" id="step_size_label"><span>step size: <span id="step_size_span">1</span></span></div>
       
        <div><input type="range" name="frame_slider" id="frame_slider" min="0" max="100" value="0"></div>
        
        <div>
            <div class="button halfButton floatLeft" id="single_reverse_button"><span>&#60;</span></div>
            <div class="button halfButton floatLeft" id="single_step_button"><span>&#62;</span></div>
        </div>
        <div>
            <div class="button halfButton floatLeft slim" id="reduce_step_button"><span>&#60;&#60;</span></div>
            <div class="button halfButton floatLeft slim" id="increase_step_button"><span>&#62;&#62;</span></div>
        </div>
        <div class="warningBox" id="buffering_warning"><span></span></div>
        <div> 
            <p>min:<span id="buff_min"></span>
            <p>max:<span id="buff_max"></span>
            <p>curr:<span id="buff_curr"></span>
        </div>
        <div class="indicator floatLeft" id="indicator"><span>&nbsp;</span></div>
    </div>
    <div class="canvasContainer">
        <canvas id="gl_canvas" width="800" height="700"></canvas>
    </div>

    <script type="text/javascript" 
        src="{{ url_for('static', filename='scripts/jquery-1.11.2.min.js') }}"></script>
    <script type="text/javascript" 
        src="{{ url_for('static', filename='scripts/glMatrix-0.9.5.min.js') }}"></script>
    <script type="text/javascript" 
        src="{{ url_for('static', filename='scripts/frame_buffer.js') }}"></script>
    <script type="text/javascript" 
        src="{{ url_for('static', filename='scripts/webgl_helpers.js') }}"></script>

    <script id="shader-fs" type="x-shader/x-fragment">
        precision mediump float;

        varying vec2 vTextureCoord;
        uniform sampler2D uSampler;
        uniform int num_channels;
        
        void main(void) {
            if (num_channels == 1) {
                vec4 myTex = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));
                gl_FragColor = myTex;
            } else {
                vec4 channel1 = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t + 0.5));
                vec4 channel2 = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));
                if (vTextureCoord.t < 0.5) {
                    gl_FragColor = vec4(channel1.s,channel2.s,0.0,0.0);
                } else {
                    gl_FragColor = vec4(0.0,0.0,0.0,0.0);
                }
            }
        }
    </script>

    <script id="shader-vs" type="x-shader/x-vertex">
        attribute vec3 aVertexPosition;
        attribute vec2 aTextureCoord;
        varying vec2 vTextureCoord;

        uniform mat4 uMVMatrix;
        uniform mat4 uPMatrix;

        void main(void) {
            gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
            vTextureCoord = aTextureCoord;
        }
    </script>

    <script type="text/javascript">
        var gl
        var zProjection
        var xProjection
        var yProjection
        var g_frameBuffer
        var g_filePath
        var g_requestStartFrame
        var g_frameDelta = 1
        var g_frameRate = 166.66
        var g_packetSize = 8
        var g_normingVal = {'0':0,'1':0}

        var g_sequenceInfo = {}
        g_sequenceInfo.max = 1
        var g_channel

        function initShaders() {
            var shaderProgram
            var fragmentShader = getShader(gl, "shader-fs")
            var vertexShader = getShader(gl, "shader-vs")

            shaderProgram = gl.createProgram()
            gl.attachShader(shaderProgram, vertexShader)
            gl.attachShader(shaderProgram, fragmentShader)
            gl.linkProgram(shaderProgram)

            if (!gl.getProgramParameter(shaderProgram, gl.LINK_STATUS)) {
                alert("Cold not initialise shaders")
            }
            gl.useProgram(shaderProgram)

            shaderProgram.vertexPositionAttribute = gl.getAttribLocation(shaderProgram, "aVertexPosition")
            gl.enableVertexAttribArray(shaderProgram.vertexPositionAttribute)

            shaderProgram.textureCoordAttribute = gl.getAttribLocation(shaderProgram, "aTextureCoord")
            gl.enableVertexAttribArray(shaderProgram.textureCoordAttribute)

            shaderProgram.pMatrixUniform = gl.getUniformLocation(shaderProgram, "uPMatrix")
            shaderProgram.mvMatrixUniform = gl.getUniformLocation(shaderProgram, "uMVMatrix")
            shaderProgram.samplerUniform = gl.getUniformLocation(shaderProgram, "uSampler")

            shaderProgram.channelsUniform = gl.getUniformLocation(shaderProgram, "num_channels")
            
            return shaderProgram
        }


        var mvMatrix = mat4.create()
        var pMatrix = mat4.create()
        function setMatrixUniforms() {
            gl.uniformMatrix4fv(zProjection.shaderProgram.pMatrixUniform, false, pMatrix)
            gl.uniformMatrix4fv(zProjection.shaderProgram.mvMatrixUniform, false, mvMatrix)
            gl.uniformMatrix4fv(xProjection.shaderProgram.pMatrixUniform, false, pMatrix)
            gl.uniformMatrix4fv(xProjection.shaderProgram.mvMatrixUniform, false, mvMatrix)
            gl.uniformMatrix4fv(yProjection.shaderProgram.pMatrixUniform, false, pMatrix)
            gl.uniformMatrix4fv(yProjection.shaderProgram.mvMatrixUniform, false, mvMatrix)
        }
        
        var squareVertexPositionBuffer
        var textureCoordBuffer
        function initBuffers() {
            squareVertexPositionBuffer = createSquareVertexPositionBuffer(gl,2.0,2.0)
            textureCoordBuffer = createTextureCoordBuffer()
        }

        var image = new Image()
        function getNextFrame(response) {
            //TODO: remove image add to zProjection.texture
            image.src = 'data:image/jpeg;base64,'+response.z_projection
            xProjection.texture.image.src = 'data:image/jpeg;base64,'+response.x_projection
            yProjection.texture.image.src = 'data:image/jpeg;base64,'+response.y_projection
        }
    
        var zoom = -3.5;
        var offset = {x:0,y:0};
        function drawScene() {
            gl.viewport(0,0, gl.viewportWidth, gl.viewportHeight)
            gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT)
            var num_channels = 1
            if ($('#channel_select').val() == 'overlay') {
                num_channels = 2
            }
            gl.uniform1i(zProjection.shaderProgram.channelsUniform, num_channels)
            gl.uniform1i(xProjection.shaderProgram.channelsUniform, num_channels)
            gl.uniform1i(yProjection.shaderProgram.channelsUniform, num_channels)

            mat4.perspective(45, gl.viewportWidth / gl.viewportHeight, 0.1, 100.0, pMatrix)

            mat4.identity(mvMatrix)

            mat4.translate(mvMatrix, [-0.25+offset.x, 0.25+offset.y, zoom])
            gl.bindBuffer(gl.ARRAY_BUFFER, zProjection.vertexPositionBuffer)
            gl.vertexAttribPointer(zProjection.shaderProgram.vertexPositionAttribute, 
                    zProjection.vertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0)

            gl.bindBuffer(gl.ARRAY_BUFFER, zProjection.textureCoordBuffer)
            gl.vertexAttribPointer(zProjection.shaderProgram.textureCoordAttribute, 
                    zProjection.textureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0)

            gl.activeTexture(gl.TEXTURE0)
            gl.bindTexture(gl.TEXTURE_2D, zProjection.texture)
            gl.uniform1i(zProjection.shaderProgram.samplerUniform, 0)
            
            setMatrixUniforms()
            gl.drawArrays(gl.TRIANGLE_STRIP, 0, zProjection.vertexPositionBuffer.numItems)

            mat4.translate(mvMatrix, [1.35, 0.0, 0.0])
            gl.bindBuffer(gl.ARRAY_BUFFER, xProjection.vertexPositionBuffer)
            gl.vertexAttribPointer(xProjection.shaderProgram.vertexPositionAttribute, 
                    xProjection.vertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0)

            gl.bindBuffer(gl.ARRAY_BUFFER, xProjection.textureCoordBuffer)
            gl.vertexAttribPointer(xProjection.shaderProgram.textureCoordAttribute, 
                    xProjection.textureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0)

            gl.activeTexture(gl.TEXTURE0)
            gl.bindTexture(gl.TEXTURE_2D, xProjection.texture)
            gl.uniform1i(xProjection.shaderProgram.samplerUniform, 0)

            setMatrixUniforms()
            gl.drawArrays(gl.TRIANGLE_STRIP, 0, xProjection.vertexPositionBuffer.numItems)

            mat4.translate(mvMatrix, [-1.35, -1.35, 0.0])
            gl.bindBuffer(gl.ARRAY_BUFFER, yProjection.vertexPositionBuffer)
            gl.vertexAttribPointer(yProjection.shaderProgram.vertexPositionAttribute, 
                    yProjection.vertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0)

            gl.bindBuffer(gl.ARRAY_BUFFER, yProjection.textureCoordBuffer)
            gl.vertexAttribPointer(yProjection.shaderProgram.textureCoordAttribute, 
                    yProjection.textureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0)

            gl.activeTexture(gl.TEXTURE0)
            gl.bindTexture(gl.TEXTURE_2D, yProjection.texture)
            gl.uniform1i(yProjection.shaderProgram.samplerUniform, 0)
            
            setMatrixUniforms()
            gl.drawArrays(gl.TRIANGLE_STRIP, 0, yProjection.vertexPositionBuffer.numItems)

        }


        var play
        var mouseState = {}
        $("#gl_canvas").ready(function webGLStart (){
            var gl_canvas = $('#gl_canvas')
            gl_canvas.bind('DOMMouseScroll mousewheel', function(event) {
                if (event.originalEvent.wheelDelta > 0 || event.originalEvent.detail < 0) {
                    zoom = Math.min(zoom+0.1,-0.1);
                } else {
                    zoom -= 0.1;
                }
                if (!play) {
                    drawScene();
                }
            });

            gl_canvas.bind('mousedown',function(){
                mouseState.mouseDown = true;
            });

            gl_canvas.bind('mouseup',function(){
                mouseState.mouseDown = false;
            });

            gl_canvas.mousemove(function(event) {
                if (mouseState.mouseDown) {
                    var dx = event.clientX - mouseState.lastMouseX
                    var dy = event.clientY - mouseState.lastMouseY
                    offset.x += dx/400
                    offset.y -= dy/400

                    if (!play) {
                        drawScene();
                    }
                }
                mouseState.lastMouseX = event.clientX;
                mouseState.lastMouseY = event.clientY;
            });

            var canvas = document.getElementById("gl_canvas")
            gl = initGL(canvas)
            zProjection = {
                shaderProgram: initShaders(),
                vertexPositionBuffer: 
                    createSquareVertexPositionBuffer(gl,2.0,2.0),
                textureCoordBuffer: createTextureCoordBuffer(),
                texture: gl.createTexture()
            }
            zProjection.texture.image = image

            xProjection = {
                shaderProgram: initShaders(),
                vertexPositionBuffer: 
                    createSquareVertexPositionBuffer(gl,0.5,2.0),
                textureCoordBuffer: createTextureCoordBuffer(),
                texture: gl.createTexture()
            }           
            xProjection.texture.image = new Image()

            yProjection = {
                shaderProgram: initShaders(),
                vertexPositionBuffer: 
                    createSquareVertexPositionBuffer(gl,2.0,0.5),
                textureCoordBuffer: createTextureCoordBuffer(),
                texture: gl.createTexture()
            }           
            yProjection.texture.image = new Image()

            gl.clearColor(0.0, 0.0, 0.0, 1.0)
            gl.enable(gl.DEPTH_TEST)
            
            play = false
        })
        
        function playFramesFromQueue(forceStep) {
            var min = g_frameBuffer.keys[0]
            var max = g_frameBuffer.maxSortedIndex
            $('#buff_min').text(g_frameBuffer.keys[0])
            $('#buff_max').text(g_frameBuffer.maxSortedIndex)
            var nextFrame = g_frameBuffer.next()
            if (g_frameBuffer.has_next()) {
                if (play || forceStep) {
                    $('#buff_curr').text(nextFrame)
                    var thisFrame = g_frameBuffer.popFrame(nextFrame)
                    if(!$('#frame_slider').hasClass('moving')) {
                        $('#frame_slider').val(nextFrame)
                    }
                    if (!thisFrame) debugger;
                    xProjection.texture.image.src = 'data:image/jpeg;base64,'+thisFrame.x
                    yProjection.texture.image.src = 'data:image/jpeg;base64,'+thisFrame.y
                    image.src = 'data:image/jpeg;base64,'+thisFrame.z
                    $('#this_frame_label').text(parseInt(nextFrame)+1)
                    setTimeout(function(){playFramesFromQueue()}, g_frameRate)

                    if (!fetching && !g_frameBuffer.isFull()) {
                        fetching = true
                        $('#buffering_warning').text('')
                        fetchFrames()
                    }
                }
            } else {
                $('#buffering_warning').text('buffering... please wait')
                play = false
                if (!fetching) {
                    fetching = true
                    fetchFrames()
                }
            } 
        }

        var fetching = true
        function fetchFrames() {
            if (fetching) {
                if (!g_frameBuffer.isFull()) {
                    var frames = g_frameBuffer.next_request(g_packetSize)
                    $.ajax({
                        url: '{{ url_for('.getFrames', _external=True) }}',
                        type: 'POST',
                        data: {
                            frames: frames.join(','),
                            path: g_filePath,
                            frameDelta: g_frameBuffer.frameDelta,
                            normingVal: g_normingVal,
                            channel: g_channel,
                            sequenceId: g_frameBuffer.sequenceId
                        },
                        cache: false,
                    }).done(function(response) {
                        if (response.sequenceId != g_frameBuffer.sequenceId) {
                            return;
                        }

                        $('#indicator').show()
                        $('#indicator').fadeOut(1000)

                        if (response.hasOwnProperty('frame_'+g_frameBuffer.next())) {
                            $('#buffering_warning').text('buffering... press start to resume playback')
                        }
                        
                        g_frameBuffer.addFrames(response)
                   
                        $('#buff_min').text(g_frameBuffer.keys[0])
                        $('#buff_max').text(g_frameBuffer.maxSortedIndex)
                        $('#buff_curr').text(g_frameBuffer.current)
                        if (response.end != true) {
                            fetchFrames() 
                        } else {
                            fetching = false
                        }
                    })
                } else {
                    fetching = false
                    if (play) {
                        $('#buffering_warning').text('')
                    } else {
                        $('#buffering_warning').text('press start to resume playback')
                    }
                }
             }
        }


        image.onload = function() {
            updateTextureData(zProjection.texture)
            updateTextureData(xProjection.texture)
            updateTextureData(yProjection.texture)
            drawScene()
            //
            //THIS IS FOR SAVING THE CANVAS AS PNG FILES
            //
            /*var c = document.getElementById('gl_canvas')
            var p = c.toDataURL()
            $.ajax({
                url: '{{ url_for('.saveImage', _external=True) }}',
                type: 'POST',
                cache: false,
                data: {
                    image: p.replace(/^data:image\/(png|jpg);base64,/, ""),
                    filename: 'frame_'+g_viewerFrame+'.png'
                }
            }).done(function(response){
            })*/
            
        }

        $('#start_button').click(function() {
            if (!play) {
                play = true
                playFramesFromQueue()
                if (fetching && play) {
                    $('#buffering_warning').text('')
                }
            }
        })

        $('#stop_button').click(function() {
            play = false
        })

        function resizeBuffers(x,y,z) {
           depth = 0.5
           if (x < y) {
                height = 2.0
                width = 2.0*x/y
           } else {
                height = 2.0*y/x
                width = 2.0
           }

           zProjection.vertexPositionBuffer = createSquareVertexPositionBuffer(gl,width,height)
           xProjection.vertexPositionBuffer = createSquareVertexPositionBuffer(gl,depth,height)
           yProjection.vertexPositionBuffer = createSquareVertexPositionBuffer(gl,width,depth)
        }
        
        function fetchInfo(filePath) {
            $.ajax({
                url: '{{ url_for('.getInfo', _external=True) }}',
                type: 'POST',
                data: {
                    path: filePath,
                },
                    cache: false,
                }).done(function(response) {
                    $('#indicator').show()
                    $('#indicator').fadeOut(1000)
                    g_sequenceInfo=response,
                    $('#frame_num_label').text(g_sequenceInfo.max)  

                    if (response['channel_0']) {
                        $('#ch1_norm_input').val(response['channel_0'])
                    }

                    if (response['channel_1']) {
                        $('#ch2_norm_input').val(response['channel_1'])
                    }

                    fetching = true
                    resizeBuffers(response.width,response.height)
                    $('#frame_slider').attr('max',g_sequenceInfo.max)
                })
        }

        function setSelectedData(newFrameIndex) {
            if (g_frameBuffer) {
                g_frameBuffer.buffer = []
            }
            g_frameBuffer = new FrameBuffer(Date.now(),350)
            g_filePath = $('#file_input').val()
            g_normingVal = [$('#ch1_norm_input').val(),$('#ch2_norm_input').val()]
            if (!g_normingVal) {
                alert('normalizing value unset')
            }
            if (g_filePath) {
                $('#buffering_warning').text('buffering.. please wait')
            }

            if ($('#channel_select').val() == 'overlay') {
                zProjection.textureCoordBuffer = createTextureCoordBuffer(2)
                xProjection.textureCoordBuffer = createTextureCoordBuffer(2)
                yProjection.textureCoordBuffer = createTextureCoordBuffer(2)
            } else {
                zProjection.textureCoordBuffer = createTextureCoordBuffer(1)
                xProjection.textureCoordBuffer = createTextureCoordBuffer(1)
                yProjection.textureCoordBuffer = createTextureCoordBuffer(1)
            }

            //$('#buff_min').text(g_frameBuffer.minKey)
            //$('#buff_max').text(g_frameBuffer.maxSortedIndex)
            $('#buff_curr').text(g_frameBuffer.current)
            fetchFrames()
        }

        function fileSelection(file) {
            var fullPath = $('#file_input').val()
            if (!fullPath) {
                fullPath = '/'
            }
            if (file != '') {
                if (fullPath.slice(-1) != '/') {
                    fullPath = fullPath + '/'
                }
                fullPath = fullPath + file  
                $('#file_input').val(fullPath)
            }

            if ((fullPath.slice(-4) == 'sima') || (fullPath.slice(-2) == 'h5')) {
                $('#channel_select').prop('disabled',true)
                fetchInfo(fullPath)
                $.get('{{ url_for('.getChannels',directory='',_external=True)}}'+fullPath.replace(/\//g , ":!"),function(html) {
                    $('#channel_select').html('')
                    $('#channel_select').html(html)
                    $('#channel_select').prop('disabled', false);
                })
            } else {
                $('#file_select').prop('disabled', true);
                $.get('{{ url_for('.getFolders',directory='',_external=True)}}'+fullPath.replace(/\//g , ":!"),function(html) {
                    $('#file_select').html('')
                    $('#file_select').html(html)
                    $('#file_select').prop('disabled', false);
                })
            }
        }

        $('#load_dataset_button').click(function() {
            var fullPath = $('#file_input').val()
            if ((fullPath.slice(-4) == 'sima') || (fullPath.slice(-2) == 'h5')) {
                g_channel = $('#channel_select').val()
                $('#load_box').addClass('hidden')
                $('#load_button').removeClass('selected')
                setSelectedData()
            }
        })

        $('#file_select').change(function() {
            fileSelection($('#file_select').val())
        })

        $('#file_get').click(function() {
            fileSelection('')
        })

        $('#load_button').click(function(){
            $('#load_button').addClass('selected')
            $('#load_box').removeClass('hidden')
            $('#ch1_norm_input').val(g_normingVal[0])
            $('#ch2_norm_input').val(g_normingVal[1])
        })

        $('#options_button').click(function(){
            $('#options_button').addClass('selected')
            $('#options_box').removeClass('hidden')

            $('#frame_rate_input').val(Math.round(String(1000/g_frameRate)))
            $('#packet_size_input').val(g_packetSize)
            $('#buffer_size_input').val(g_frameBuffer.maxLength)
        })

        $('#options_cancel').click(function() {
            $('#options_box').addClass('hidden')
            $('#options_button').removeClass('selected')
            g_frameRate = 1000/$('#frame_rate_input').val()
            g_packetSize = parseInt($('#packet_size_input').val(),10)
            if (g_frameBuffer) {
                g_frameBuffer.maxLength = parseInt($('#buffer_size_input').val(),10)
                var normingVal = $('#norming_value_input').val()
                
            }
        })

        $('#file_up_level').click(function() {
            var path = $('#file_input').val()
            if (path) {
                $('#file_input').val(path.substring(0,path.lastIndexOf('/')))
                fileSelection('') 
            }
        })

        $('#file_cancel').click(function() {
            $('#load_box').addClass('hidden')
            $('#load_button').removeClass('selected')
        })

        $('#increase_step_button').click(function() {
            if (g_frameBuffer.frameDelta > 0) {
                g_frameBuffer.set_frameDelta(g_frameBuffer.frameDelta*2)
            } else if (g_frameBuffer.frameDelta == -1) {
                g_frameBuffer.set_frameDelta(g_frameBuffer.frameDelta*-1)
            } else {
                g_frameBuffer.set_frameDelta(g_frameBuffer.frameDelta / 2)
            }
            $('#step_size_span').text(g_frameBuffer.frameDelta)

            if (!fetching) {
                fetching = true
                fetchFrames()
            }

        })

        $('#reduce_step_button').click(function() {
            if (g_frameBuffer.frameDelta < 0) {
                g_frameBuffer.set_frameDelta(g_frameBuffer.frameDelta * 2)
            } else if (g_frameBuffer.frameDelta == 1) {
                g_frameBuffer.set_frameDelta(g_frameBuffer.frameDelta * -1)
            } else {
                g_frameBuffer.set_frameDelta(g_frameBuffer.frameDelta / 2)
            }
            $('#step_size_span').text(g_frameBuffer.frameDelta)

            if (!fetching) {
                fetching = true
                fetchFrames()
            }
        })

        $('#single_step_button').click(function(){
            var frameDelta = g_frameBuffer.frameDelta
            g_frameBuffer.set_frameDelta(Math.abs(g_frameBuffer.frameDelta))
            playFramesFromQueue(true)
            g_frameBuffer.set_frameDelta(frameDelta)
        })

        $('#single_reverse_button').click(function(){
            var frameDelta = g_frameBuffer.frameDelta
            g_frameBuffer.set_frameDelta(-Math.abs(g_frameBuffer.frameDelta))
            playFramesFromQueue(true)
            g_frameBuffer.set_frameDelta(frameDelta)
        })
        
        $('#frame_slider').mousedown(function() {
            $(this).addClass('moving')
        })

        $('#frame_slider').mouseup(function() {
            $(this).removeClass('moving')
            g_frameBuffer.set_next($('#frame_slider').val())
        })

    </script>

</body>

</html>
